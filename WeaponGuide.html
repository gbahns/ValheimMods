<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valheim Interactive Armory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=MedievalSharp&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Ashen Oak -->
    <!-- Application Structure Plan: The application is designed as a multi-section, single-page dashboard. The user can navigate between distinct, task-oriented sections using a persistent top navigation bar. The sections are: 1) 'Home/Intro' to set the scene. 2) 'Combat Guide' for fundamental mechanics, presented in an easy-to-digest accordion format. 3) 'Weapon Explorer', the core of the app, featuring powerful filters (by tier, type, damage) and an interactive table to compare weapons. 4) 'Enemy Intel', a filterable database of creatures and their vulnerabilities. This structure was chosen over a linear report format to empower users to find specific information quickly. A player can ask "What blunt weapon is best for the Swamp?" and use the filters to get an immediate answer, which is a more natural user flow for a game guide. -->
    <!-- Visualization & Content Choices: 
         - Report Info: Comprehensive list of all weapons with stats and recipes. -> Goal: Allow users to browse, filter, and compare all weapons. -> Viz/Presentation: Interactive HTML Table. -> Interaction: Users can filter by biome/tier, weapon type, and damage type using dropdowns and buttons. -> Justification: A filterable table is the most efficient way to handle a large dataset like this, letting users narrow down the options to their specific needs.
         - Report Info: Enemy vulnerability data. -> Goal: Provide quick reference for combat preparation. -> Viz/Presentation: Card-based grid layout. -> Interaction: Filter by biome to see relevant threats. -> Justification: Cards allow for a visually appealing presentation of enemy info, including an image placeholder and key data points in a scannable format.
         - Report Info: Core combat mechanics. -> Goal: Educate users on game fundamentals. -> Viz/Presentation: HTML Accordion. -> Interaction: Users can click to expand/collapse sections. -> Justification: An accordion prevents the initial view from being overwhelmed with text, allowing users to explore the mechanics they are interested in without excessive scrolling.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2D3748; /* bg-gray-800 */
        }
        .font-medieval {
            font-family: 'MedievalSharp', cursive;
        }
        .nav-link {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active, .nav-link:hover {
            color: #FBBF24; /* amber-400 */
            border-bottom-color: #FBBF24; /* amber-400 */
        }
        .filter-btn {
            transition: all 0.2s ease;
        }
        .filter-btn.active {
            background-color: #FBBF24; /* amber-400 */
            color: #1A202C; /* gray-900 */
            font-weight: 600;
        }
        .table-row-clickable:hover {
            background-color: #4A5568; /* gray-700 */
        }
        .table-row-clickable.selected {
            background-color: #5A6578; /* gray-600 */
            outline: 2px solid #FBBF24; /* amber-400 */
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        th.sortable {
            cursor: pointer;
        }
        th.sortable:hover {
            color: #FBBF24;
        }
        th.sort-asc::after, th.sort-desc::after {
            content: '';
            display: inline-block;
            margin-left: 0.5em;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
        }
        th.sort-asc::after {
            border-bottom: 4px solid #FBBF24;
        }
        th.sort-desc::after {
            border-top: 4px solid #FBBF24;
        }
        .level-selector {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .level-selector:hover {
            background-color: rgba(251, 191, 36, 0.2);
        }
        .level-selected {
            background-color: rgba(251, 191, 36, 0.4);
            font-weight: bold;
            color: #FBBF24;
        }
        .damage-bar-container {
            background-color: #4A5568;
            border-radius: 0.25rem;
            overflow: hidden;
            position: relative;
            height: 1.25rem;
        }
        .damage-bar {
            background-color: #FBBF24;
            height: 100%;
            transition: width 0.3s ease-in-out;
            white-space: nowrap;
            text-align: right;
            padding-right: 4px;
            color: #1A202C;
            font-weight: bold;
            font-size: 0.75rem;
            line-height: 1.25rem;
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-200">

    <header class="bg-gray-900 shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-medieval text-white">Valheim Armory</h1>
            <div class="hidden md:flex space-x-6 text-lg">
                <a href="#home" class="nav-link">Home</a>
                <a href="#combat" class="nav-link">Combat Guide</a>
                <a href="#explorer" class="nav-link active">Weapon Explorer</a>
                <a href="#intel" class="nav-link">Enemy Intel</a>
            </div>
            <div class="md:hidden">
                <select id="mobile-nav" class="bg-gray-800 text-white border border-gray-600 rounded-md p-2">
                    <option value="#home">Home</option>
                    <option value="#combat">Combat Guide</option>
                    <option value="#explorer" selected>Weapon Explorer</option>
                    <option value="#intel">Enemy Intel</option>
                </select>
            </div>
        </nav>
    </header>

    <main>
        <section id="home" class="min-h-screen flex items-center justify-center text-center bg-gray-800 px-4 hidden">
            <div class="max-w-4xl">
                <h2 class="text-5xl md:text-7xl font-medieval text-amber-400 mb-4">Forge Your Legend</h2>
                <p class="text-lg md:text-xl text-gray-300 mb-8">Welcome to the interactive armory for Valheim. This guide translates the comprehensive weapon report into a practical, hands-on tool. Here, you won't just read about weapons; you'll explore, compare, and strategize. Use the navigation above to delve into combat mechanics, explore the full arsenal of weapons with powerful filters, and study your foes' weaknesses. Prepare yourself, Vikingâ€”Odin is watching.</p>
                <a href="#explorer" class="bg-amber-400 text-gray-900 font-bold py-3 px-8 rounded-lg hover:bg-amber-500 transition-colors duration-300 text-xl">Explore Weapons</a>
            </div>
        </section>

        <section id="combat" class="py-20 bg-gray-900 px-4 hidden">
            <div class="container mx-auto">
                <h2 class="text-4xl font-medieval text-center text-amber-400 mb-12">The Art of Viking Combat</h2>
                <div class="max-w-3xl mx-auto space-y-4" id="accordion-container">
                </div>
            </div>
        </section>

        <section id="explorer" class="py-4 bg-gray-800 px-1">
            <div class="container mx-auto">
                <div class="bg-gray-900 p-6 rounded-lg shadow-xl mb-8">
                    <div class="flex items-start gap-6 mb-4">
                        <div class="flex-shrink-0 pt-5">
                            <button id="skill-toggle-btn" class="filter-btn text-sm py-2 px-4 rounded w-32 active">My Skills</button>
                        </div>
                        <div id="skill-inputs-wrapper" class="flex-grow overflow-hidden transition-all duration-300 ease-in-out">
                            <div id="skill-inputs" class="grid grid-cols-3 sm:grid-cols-5 md:grid-cols-9 gap-x-4 gap-y-3 pb-4">
                                <!-- Skill inputs will be generated here -->
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-4 pt-4 border-t border-gray-700">
                        <div class="flex flex-wrap items-end gap-4">
                                <div>
                                    <label for="tier-filter" class="block text-sm font-medium text-gray-300 mb-2">Tier</label>
                                    <select id="tier-filter" class="w-auto bg-gray-800 border border-gray-600 rounded-md p-2 focus:ring-amber-400 focus:border-amber-400">
                                        <option value="all">All Tiers</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="type-filter" class="block text-sm font-medium text-gray-300 mb-2">Weapon Type</label>
                                    <select id="type-filter" class="w-auto bg-gray-800 border border-gray-600 rounded-md p-2 focus:ring-amber-400 focus:border-amber-400">
                                        <option value="all">All Types</option>
                                    </select>
                                </div>
                                <div id="arrow-filter-container" class="hidden">
                                    <label for="arrow-filter" class="block text-sm font-medium text-gray-300 mb-2">Arrow Type</label>
                                    <select id="arrow-filter" class="w-auto bg-gray-800 border border-gray-600 rounded-md p-2 focus:ring-amber-400 focus:border-amber-400">
                                        <!-- Options populated by JS -->
                                    </select>
                                </div>
                                 <div class="w-48">
                                    <label for="damage-filter-btn" class="block text-sm font-medium text-gray-300 mb-2">Primary Damage</label>
                                    <div class="relative">
                                        <button id="damage-filter-btn" class="w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-left focus:ring-amber-400 focus:border-amber-400 text-sm truncate">Select Damage Types</button>
                                        <div id="damage-filter-dropdown" class="absolute z-10 hidden w-full bg-gray-700 border border-gray-600 rounded-md mt-1 shadow-lg p-2 space-y-1">
                                            <!-- Checkbox options populated by JS -->
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-6 ml-auto">
                                     <div class="flex flex-col">
                                        <div class="flex items-center">
                                            <input id="include-previous-tiers" type="checkbox" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-amber-500 focus:ring-amber-500">
                                            <label for="include-previous-tiers" class="ml-2 block text-sm text-gray-300">Include Previous</label>
                                        </div>
                                         <div class="flex items-center mt-2">
                                            <input id="show-damage-details" type="checkbox" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-amber-500 focus:ring-amber-500">
                                            <label for="show-damage-details" class="ml-2 block text-sm text-gray-300">Damage Columns</label>
                                        </div>
                                    </div>
                                </div>
                        </div>
                        <div id="enemy-info-container" class="flex items-start gap-6 pt-4 border-t border-gray-700">
                             <div>
                                <label for="enemy-selector" class="block text-sm font-medium text-gray-300 mb-2">Enemy</label>
                                <select id="enemy-selector" class="w-auto bg-gray-800 border border-gray-600 rounded-md p-2 focus:ring-amber-400 focus:border-amber-400">
                                    <option value="none">-- Select an Enemy --</option>
                                </select>
                            </div>
                            <div id="enemy-info-panel" class="bg-gray-800 p-2 rounded-lg flex-grow">
                                <!-- Enemy info will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row gap-8">
                    <div id="table-panel" class="lg:w-full overflow-x-auto bg-gray-900 p-4 rounded-lg shadow-xl">
                        <table class="min-w-full text-sm">
                            <thead class="border-b border-gray-600">
                                <tr id="weapon-table-header">
                                    <th class="p-2 text-left font-semibold text-gray-300 tracking-wider sortable" data-sort="name">Weapon</th>
                                    <th class="p-2 text-left font-semibold text-gray-300 tracking-wider sortable" data-sort="type">Type</th>
                                    <th class="p-2 text-left font-semibold text-gray-300 tracking-wider sortable" data-sort="tier">Tier</th>
                                    <th class="p-2 text-center font-bold text-gray-300 tracking-wider sortable" data-sort="lvl1">Lvl 1</th>
                                    <th class="p-2 text-center font-bold text-gray-300 tracking-wider sortable" data-sort="lvl2">Lvl 2</th>
                                    <th class="p-2 text-center font-bold text-gray-300 tracking-wider sortable" data-sort="lvl3">Lvl 3</th>
                                    <th class="p-2 text-center font-bold text-gray-300 tracking-wider sortable" data-sort="lvl4">Lvl 4</th>
                                    <th class="p-2 text-center font-bold text-amber-400 tracking-wider sortable" data-sort="vsFoe">vs. Foe</th>
                                    <th class="p-2 text-center font-bold text-amber-400 tracking-wider sortable" data-sort="dps">DPS</th>
                                    <th class="p-2 text-center font-bold text-amber-400 tracking-wider sortable" data-sort="comboDps">Combo DPS</th>
                                    <th class="p-2 text-center text-gray-300 tracking-wider sortable" data-sort="staminaCost">Stamina</th>
                                    <th class="p-2 text-center font-bold text-amber-400 tracking-wider sortable" data-sort="dmgPerStamina">Dmg/Stam</th>
                                    <th id="damage-bar-header" class="p-2 text-left font-semibold text-gray-300 tracking-wider sortable" data-sort="damageBar" style="min-width: 150px;">DPS</th>
                                    <th class="p-2 text-center font-semibold text-gray-300 tracking-wider damage-col sortable" data-sort="Blunt" title="Blunt">Blunt</th>
                                    <th class="p-2 text-center font-semibold text-gray-300 tracking-wider damage-col sortable" data-sort="Slash" title="Slash">Slash</th>
                                    <th class="p-2 text-center font-semibold text-gray-300 tracking-wider damage-col sortable" data-sort="Pierce" title="Pierce">Pierce</th>
                                </tr>
                            </thead>
                            <tbody id="weapon-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="intel" class="py-20 bg-gray-900 px-4 hidden">
            <div class="container mx-auto">
                <h2 class="text-4xl font-medieval text-center text-amber-400 mb-4">Enemy Intel</h2>
                <p class="text-center text-gray-400 max-w-3xl mx-auto mb-12">"Know thy foe." This section provides crucial intelligence on the creatures of Valheim. Filter by biome to prepare for your expeditions. Understanding an enemy's weaknesses and resistances is the first step to victory.</p>
                <div class="flex justify-center mb-8 gap-4">
                    <select id="enemy-biome-filter" class="w-full max-w-sm bg-gray-800 border border-gray-600 rounded-md p-2 focus:ring-amber-400 focus:border-amber-400">
                        <option value="all">All Biomes</option>
                    </select>
                    <div id="view-toggle-buttons" class="flex items-center bg-gray-800 border border-gray-600 rounded-md p-1">
                        <button class="filter-btn px-4 py-1 rounded" data-view="cards">Cards</button>
                        <button class="filter-btn px-4 py-1 rounded" data-view="table">Table</button>
                    </div>
                </div>
                <div id="enemy-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                </div>
                <div id="enemy-table-container" class="hidden overflow-x-auto bg-gray-900 p-4 rounded-lg shadow-xl">
                    <table class="min-w-full text-sm">
                        <thead class="border-b border-gray-600">
                            <tr id="enemy-table-header">
                                <th class="p-2 text-left font-semibold text-gray-300 sortable" data-sort="name">Creature</th>
                                <th class="p-2 text-left font-semibold text-gray-300 sortable" data-sort="biome">Biome</th>
                                <th class="p-2 text-left font-semibold text-green-400 sortable" data-sort="weak" title="Weak: 1.5x Damage, *Very Weak: 2x Damage">Weakness</th>
                                <th class="p-2 text-left font-semibold text-red-400 sortable" data-sort="resist" title="Resistant: 0.5x Damage, *Very Resistant: 0.25x Damage">Resistance</th>
                                <th class="p-2 text-left font-semibold text-gray-500 sortable" data-sort="immune">Immunity</th>
                            </tr>
                        </thead>
                        <tbody id="enemy-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="bg-gray-900 text-center py-6 mt-20">
        <p class="text-gray-500">Valheim Interactive Armory | Data sourced from community reports.</p>
    </footer>

    <script>
        const weaponData = [
            { name: 'Stone Axe', type: 'Axe (1H)', tier: 'Meadows', damage: { Slash: 15 }, maxLvlDamage: 24, totalDamage: 15, attackSpeed: 1.2, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: true },
            { name: 'Flint Axe', type: 'Axe (1H)', tier: 'Meadows', damage: { Slash: 20 }, maxLvlDamage: 29, totalDamage: 20, attackSpeed: 1.2, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: true },
            { name: 'Club', type: 'Club (1H)', tier: 'Meadows', damage: { Blunt: 12 }, maxLvlDamage: 21, totalDamage: 12, attackSpeed: 1.1, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: true },
            { name: 'Flint Knife', type: 'Knife (1H)', tier: 'Meadows', damage: { Slash: 5, Pierce: 5 }, maxLvlDamage: 16, totalDamage: 10, attackSpeed: 0.8, staminaCost: 6, backstab: 10, secondaryMult: 3, hasCombo: true },
            { name: 'Flint Spear', type: 'Spear (2H)', tier: 'Meadows', damage: { Pierce: 20 }, maxLvlDamage: 35, totalDamage: 20, attackSpeed: 1.2, staminaCost: 12, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Crude Bow', type: 'Bow (2H)', tier: 'Meadows', damage: { Pierce: 22 }, maxLvlDamage: 31, totalDamage: 22, attackSpeed: 2.0, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Abyssal Razor', type: 'Knife (1H)', tier: 'Black Forest', damage: { Slash: 24, Pierce: 24 }, maxLvlDamage: 66, totalDamage: 48, attackSpeed: 0.8, staminaCost: 6, backstab: 10, secondaryMult: 3, hasCombo: true },
            { name: 'Abyssal Razor', type: 'Knife (1H)', tier: 'Swamp', damage: { Slash: 24, Pierce: 24 }, maxLvlDamage: 66, totalDamage: 48, attackSpeed: 0.8, staminaCost: 6, backstab: 10, secondaryMult: 3, hasCombo: true },
            { name: 'Abyssal Harpoon', type: 'Harpoon (2H)', tier: 'Black Forest', damage: { Pierce: 10 }, maxLvlDamage: 10, totalDamage: 10, attackSpeed: 1.2, staminaCost: 12, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Stagbreaker', type: 'Sledge (2H)', tier: 'Black Forest', damage: { Blunt: 20, Pierce: 5 }, maxLvlDamage: 40, totalDamage: 25, attackSpeed: 2.0, staminaCost: 20, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Copper Knife', type: 'Knife (1H)', tier: 'Black Forest', damage: { Slash: 9, Pierce: 9 }, maxLvlDamage: 36, totalDamage: 18, attackSpeed: 0.8, staminaCost: 6, backstab: 10, secondaryMult: 3, hasCombo: true },
            { name: 'Bronze Axe', type: 'Axe (1H)', tier: 'Black Forest', damage: { Slash: 35 }, maxLvlDamage: 50, totalDamage: 35, attackSpeed: 1.2, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: true },
            { name: 'Bronze Mace', type: 'Mace (1H)', tier: 'Black Forest', damage: { Blunt: 35 }, maxLvlDamage: 50, totalDamage: 35, attackSpeed: 1.1, staminaCost: 10, backstab: 3, secondaryMult: 2.5, hasCombo: true },
            { name: 'Bronze Sword', type: 'Sword (1H)', tier: 'Black Forest', damage: { Slash: 35 }, maxLvlDamage: 50, totalDamage: 35, attackSpeed: 1.0, staminaCost: 10, backstab: 3, secondaryMult: 2, hasCombo: true },
            { name: 'Bronze Spear', type: 'Spear (2H)', tier: 'Black Forest', damage: { Pierce: 35 }, maxLvlDamage: 50, totalDamage: 35, attackSpeed: 1.2, staminaCost: 12, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Bronze Atgeir', type: 'Atgeir (2H)', tier: 'Black Forest', damage: { Pierce: 45 }, maxLvlDamage: 60, totalDamage: 45, attackSpeed: 1.5, staminaCost: 15, backstab: 3, secondaryMult: 1.5, hasCombo: true },
            { name: 'Finewood Bow', type: 'Bow (2H)', tier: 'Black Forest', damage: { Pierce: 32 }, maxLvlDamage: 41, totalDamage: 32, attackSpeed: 2.0, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Iron Axe', type: 'Axe (1H)', tier: 'Swamp', damage: { Slash: 55 }, maxLvlDamage: 70, totalDamage: 55, attackSpeed: 1.2, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: true },
            { name: 'Iron Mace', type: 'Mace (1H)', tier: 'Swamp', damage: { Blunt: 55 }, maxLvlDamage: 70, totalDamage: 55, attackSpeed: 1.1, staminaCost: 10, backstab: 3, secondaryMult: 2.5, hasCombo: true },
            { name: 'Iron Sledge', type: 'Sledge (2H)', tier: 'Swamp', damage: { Blunt: 55, Spirit: 30 }, maxLvlDamage: 100, totalDamage: 85, attackSpeed: 2.0, staminaCost: 20, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Battleaxe', type: 'Axe (2H)', tier: 'Swamp', damage: { Slash: 70 }, maxLvlDamage: 85, totalDamage: 70, attackSpeed: 1.8, staminaCost: 18, backstab: 3, secondaryMult: 1.5, hasCombo: true },
            { name: 'Iron Sword', type: 'Sword (1H)', tier: 'Swamp', damage: { Slash: 55 }, maxLvlDamage: 70, totalDamage: 55, attackSpeed: 1.0, staminaCost: 10, backstab: 3, secondaryMult: 2, hasCombo: true },
            { name: 'Iron Atgeir', type: 'Atgeir (2H)', tier: 'Swamp', damage: { Pierce: 65 }, maxLvlDamage: 80, totalDamage: 65, attackSpeed: 1.5, staminaCost: 15, backstab: 3, secondaryMult: 1.5, hasCombo: true },
            { name: 'Ancient Bark Spear', type: 'Spear (2H)', tier: 'Swamp', damage: { Pierce: 55 }, maxLvlDamage: 70, totalDamage: 55, attackSpeed: 1.2, staminaCost: 12, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Huntsman Bow', type: 'Bow (2H)', tier: 'Swamp', damage: { Pierce: 42 }, maxLvlDamage: 51, totalDamage: 42, attackSpeed: 2.0, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Flesh Rippers', type: 'Fist (1H)', tier: 'Mountains', damage: { Slash: 60 }, maxLvlDamage: 75, totalDamage: 60, attackSpeed: 0.7, staminaCost: 5, backstab: 6, secondaryMult: 3, hasCombo: true },
            { name: 'Silver Knife', type: 'Knife (1H)', tier: 'Mountains', damage: { Slash: 21, Pierce: 21, Spirit: 12 }, maxLvlDamage: 66, totalDamage: 54, attackSpeed: 0.8, staminaCost: 6, backstab: 10, secondaryMult: 3, hasCombo: true },
            { name: 'Silver Sword', type: 'Sword (1H)', tier: 'Mountains', damage: { Slash: 75, Spirit: 30 }, maxLvlDamage: 120, totalDamage: 105, attackSpeed: 1.0, staminaCost: 10, backstab: 3, secondaryMult: 2, hasCombo: true },
            { name: 'Frostner', type: 'Mace (1H)', tier: 'Mountains', damage: { Blunt: 35, Frost: 40, Spirit: 20 }, maxLvlDamage: 128, totalDamage: 95, attackSpeed: 1.1, staminaCost: 10, backstab: 3, secondaryMult: 2.5, hasCombo: true },
            { name: 'Fang Spear', type: 'Spear (2H)', tier: 'Mountains', damage: { Pierce: 70 }, maxLvlDamage: 85, totalDamage: 70, attackSpeed: 1.2, staminaCost: 12, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Crystal Battleaxe', type: 'Axe (2H)', tier: 'Mountains', damage: { Slash: 90, Spirit: 30 }, maxLvlDamage: 135, totalDamage: 120, attackSpeed: 1.8, staminaCost: 18, backstab: 3, secondaryMult: 1.5, hasCombo: true },
            { name: 'Draugr Fang', type: 'Bow (2H)', tier: 'Mountains', damage: { Pierce: 47, Poison: 5 }, maxLvlDamage: 76, totalDamage: 52, attackSpeed: 2.0, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Porcupine', type: 'Mace (1H)', tier: 'Plains', damage: { Blunt: 50, Pierce: 45 }, maxLvlDamage: 125, totalDamage: 95, attackSpeed: 1.1, staminaCost: 10, backstab: 3, secondaryMult: 2.5, hasCombo: true },
            { name: 'Blackmetal Axe', type: 'Axe (1H)', tier: 'Plains', damage: { Slash: 95 }, maxLvlDamage: 110, totalDamage: 95, attackSpeed: 1.2, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: true },
            { name: 'Blackmetal Knife', type: 'Knife (1H)', tier: 'Plains', damage: { Slash: 28, Pierce: 28 }, maxLvlDamage: 74, totalDamage: 56, attackSpeed: 0.8, staminaCost: 6, backstab: 10, secondaryMult: 3, hasCombo: true },
            { name: 'Blackmetal Sword', type: 'Sword (1H)', tier: 'Plains', damage: { Slash: 95 }, maxLvlDamage: 110, totalDamage: 95, attackSpeed: 1.0, staminaCost: 10, backstab: 3, secondaryMult: 2, hasCombo: true },
            { name: 'Blackmetal Atgeir', type: 'Atgeir (2H)', tier: 'Plains', damage: { Pierce: 105 }, maxLvlDamage: 120, totalDamage: 105, attackSpeed: 1.5, staminaCost: 15, backstab: 3, secondaryMult: 1.5, hasCombo: true },
            { name: 'Mistwalker', type: 'Sword (1H)', tier: 'Mistlands', damage: { Slash: 75, Frost: 40 }, maxLvlDamage: 127, totalDamage: 115, attackSpeed: 1.0, staminaCost: 10, backstab: 3, secondaryMult: 2, hasCombo: true },
            { name: 'Krom', type: 'Sword (2H)', tier: 'Mistlands', damage: { Slash: 150 }, maxLvlDamage: 162, totalDamage: 150, attackSpeed: 1.5, staminaCost: 10, backstab: 3, secondaryMult: 1.5, hasCombo: true },
            { name: 'Demolisher', type: 'Sledge (2H)', tier: 'Mistlands', damage: { Blunt: 140 }, maxLvlDamage: 152, totalDamage: 140, attackSpeed: 2.0, staminaCost: 20, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Jotun Bane', type: 'Axe (1H)', tier: 'Mistlands', damage: { Slash: 80, Poison: 30 }, maxLvlDamage: 122, totalDamage: 110, attackSpeed: 1.2, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: true },
            { name: 'Spine Snap', type: 'Bow (2H)', tier: 'Mistlands', damage: { Pierce: 62 }, maxLvlDamage: 68, totalDamage: 62, attackSpeed: 2.0, staminaCost: 10, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Arbalest', type: 'Crossbow (2H)', tier: 'Mistlands', damage: { Pierce: 200 }, maxLvlDamage: 209, totalDamage: 200, attackSpeed: 3.0, staminaCost: 15, backstab: 3, secondaryMult: 1, hasCombo: false },
            { name: 'Staff of Embers', type: 'Staff (2H)', tier: 'Mistlands', damage: { Blunt: 120, Fire: 120 }, maxLvlDamage: 276, totalDamage: 240, attackSpeed: 1.5, staminaCost: 0, backstab: 1, secondaryMult: 1, hasCombo: false },
            { name: 'Staff of Frost', type: 'Staff (2H)', tier: 'Mistlands', damage: { Frost: 30 }, maxLvlDamage: 36, totalDamage: 30, attackSpeed: 0.25, staminaCost: 0, backstab: 1, hasCombo: false },
        ];

        const combatData = [
            { title: "Deconstructing Damage", content: "Damage is split into physical (Blunt, Slash, Pierce) and elemental (Fire, Frost, Spirit, Poison). Yellow numbers mean an enemy is weak (1.5x damage), grey means resistant (0.5x damage), and white is neutral (1x damage). Matching damage type to enemy weakness is the core of combat strategy." },
            { title: "Stamina Management", content: "Stamina is your most critical resource. Attacking, blocking, dodging, and running all consume it. Running out of stamina leaves you helpless. Always fight rested and with a full stomach from good food to maximize your stamina pool and regeneration." },
            { title: "Blocking & Parrying", content: "Blocking absorbs damage based on your shield's Block Power. Parrying (blocking at the last second) negates all damage and staggers the enemy, leaving them open for critical hits. A successful parry is a huge tactical advantage." },
            { title: "Staggering & Backstabbing", content: "Every hit contributes to an enemy's invisible stagger bar. When it fills, they are stunned. Aim for combos to stagger foes. Backstabbing an unaware enemy provides a massive damage bonus, especially with knives which have a 10x multiplier." },
            { title: "Attack Chains & Special Attacks", content: "Most weapons have a three-hit combo. The final hit is usually the strongest. Don't just spam the first attack. The middle-mouse button unleashes a powerful but stamina-heavy secondary attack, like the Atgeir's spin, which is great for crowd control." },
        ];

        const enemyData = [
            { name: 'Neck', biome: 'Meadows', weak: 'Frost, Lightning', resist: '', immune: 'Poison', notes: 'Small lizards found near water.' },
            { name: 'Greyling', biome: 'Meadows', weak: 'Fire', resist: '', immune: '', notes: 'Weaker version of the Greydwarf.' },
            { name: 'Eikthyr', biome: 'Meadows', weak: '', resist: '', immune: '', notes: 'First boss, no specific weaknesses.' },
            { name: 'Greydwarf', biome: 'Black Forest', weak: 'Fire', resist: '', immune: 'Spirit', notes: 'Common forest enemy.' },
            { name: 'Greydwarf Brute', biome: 'Black Forest', weak: 'Fire', resist: '', immune: 'Spirit', notes: 'Larger, tougher Greydwarf.' },
            { name: 'Greydwarf Shaman', biome: 'Black Forest', weak: 'Fire', resist: '', immune: 'Spirit', notes: 'Heals others and uses a poison spray.' },
            { name: 'Troll', biome: 'Black Forest', weak: 'Pierce', resist: 'Blunt', immune: 'Spirit', notes: 'Large and dangerous. Aim for the head.' },
            { name: 'Skeleton', biome: 'Black Forest', weak: 'Blunt, Fire', resist: 'Pierce, Frost', immune: 'Poison', notes: 'Found in Burial Chambers.' },
            { name: 'Ghost', biome: 'Black Forest', weak: 'Spirit', resist: 'Blunt, Slash, Pierce', immune: 'Poison', notes: 'Found in Burial Chambers.' },
            { name: 'Rancid Remains', biome: 'Black Forest', weak: 'Blunt, Fire', resist: 'Pierce', immune: 'Poison', notes: 'A tougher, poisonous skeleton.' },
            { name: 'The Elder', biome: 'Black Forest', weak: 'Fire', resist: '', immune: 'Poison, Spirit', notes: 'Second boss. Use fire arrows.' },
            { name: 'Blob', biome: 'Swamp', weak: 'Blunt, Frost, Lightning', resist: 'Slash, Pierce, Fire', immune: 'Poison', notes: 'Explodes into a poison cloud.' },
            { name: 'Oozer', biome: 'Swamp', weak: 'Blunt, Frost, Lightning', resist: 'Slash, Pierce, Fire', immune: 'Poison', notes: 'Spawns smaller Blobs on death.' },
            { name: 'Draugr', biome: 'Swamp', weak: '', resist: 'Fire', immune: 'Poison', notes: 'Common undead enemy.' },
            { name: 'Draugr Elite', biome: 'Swamp', weak: '', resist: 'Fire', immune: 'Poison', notes: 'Tougher version of the Draugr.' },
            { name: 'Leech', biome: 'Swamp', weak: 'Frost, Lightning', resist: '', immune: 'Poison, Spirit', notes: 'Water-based enemy.' },
            { name: 'Surtling', biome: 'Swamp', weak: 'Frost', resist: '', immune: 'Fire, Poison, Spirit', notes: 'Fire demons that die instantly in water.' },
            { name: 'Wraith', biome: 'Swamp', weak: 'Fire, Spirit', resist: 'Blunt, Slash, Pierce', immune: 'Frost, Poison', notes: 'Flying enemy that appears at night.' },
            { name: 'Abomination', biome: 'Swamp', weak: 'Slash, Fire', resist: 'Blunt, Pierce, Frost, Lightning', immune: 'Poison, Spirit', notes: 'Large, tree-like mini-boss.' },
            { name: 'Bonemass', biome: 'Swamp', weak: 'Blunt, Frost, Spirit', veryResist: 'Slash, Pierce, Fire', immune: 'Poison', notes: 'Third boss. Very resistant to physical damage.' },
            { name: 'Wolf', biome: 'Mountains', weak: '', resist: '', immune: 'Spirit', notes: 'Fast and aggressive. Parrying is key.' },
            { name: 'Fenring', biome: 'Mountains', weak: 'Fire, Spirit', resist: '', immune: 'Frost, Poison', notes: 'Werewolf-like creature appearing at night.' },
            { name: 'Drake', biome: 'Mountains', weak: 'Fire', resist: '', immune: 'Frost, Spirit', notes: 'Flying dragon-like creatures.' },
            { name: 'Stone Golem', biome: 'Mountains', weak: 'Pickaxe', resist: 'Blunt, Slash, Pierce', immune: 'Fire, Frost, Poison, Spirit', notes: 'Resistant to all normal weapon damage.' },
            { name: 'Ulv', biome: 'Mountains', weak: 'Fire, Spirit', resist: '', immune: 'Frost, Poison', notes: 'Tougher wolf found in Frost Caves.' },
            { name: 'Cultist', biome: 'Mountains', weak: 'Blunt, Spirit', resist: 'Slash, Pierce', immune: 'Fire, Frost, Poison', notes: 'Tusked humanoid in Frost Caves.' },
            { name: 'Moder', biome: 'Mountains', weak: 'Fire', resist: '', immune: 'Frost, Spirit', notes: 'Fourth boss, a large flying dragon.' },
            { name: 'Fuling', biome: 'Plains', weak: '', resist: '', immune: 'Spirit', notes: 'Common goblin-like enemies.' },
            { name: 'Fuling Berserker', biome: 'Plains', weak: '', resist: '', immune: 'Spirit', notes: 'Large, club-wielding Fulings.' },
            { name: 'Fuling Shaman', biome: 'Plains', weak: '', resist: '', immune: 'Spirit', notes: 'Casts a protective shield on others.' },
            { name: 'Deathsquito', biome: 'Plains', weak: 'Pierce', resist: '', immune: '', notes: 'Low health but extremely high damage.' },
            { name: 'Lox', biome: 'Plains', weak: 'Fire, Frost', resist: 'Blunt, Slash', immune: 'Spirit', notes: 'Large, bison-like creatures.' },
            { name: 'Growth', biome: 'Plains', weak: 'Blunt, Fire', resist: 'Frost, Pierce, Slash', immune: 'Poison, Stagger', notes: 'Tar-like blobs found near tar pits.' },
            { name: 'Yagluth', biome: 'Plains', weak: 'Frost, Lightning, Spirit', veryResist: 'Pierce', immune: 'Fire, Poison', notes: 'Fifth boss, a giant skeleton.' },
            { name: 'Seeker', biome: 'Mistlands', weak: '', resist: 'Blunt, Slash, Pierce', immune: 'Spirit', notes: 'Insectoid creature, very aggressive.' },
            { name: 'Seeker Soldier', biome: 'Mistlands', weak: 'Weak spot on rear', resist: 'Blunt, Slash, Pierce', immune: 'Spirit', notes: 'Armored version of the Seeker.' },
            { name: 'Seeker Brood', biome: 'Mistlands', weak: '', resist: '', immune: '', notes: 'Small, non-hostile Seeker young.' },
            { name: 'Gjall', biome: 'Mistlands', weak: 'Weak spot on underbelly', resist: 'Fire', immune: 'Spirit', notes: 'Large, floating creature that spawns Ticks.' },
            { name: 'Tick', biome: 'Mistlands', weak: 'Pierce, Fire', resist: '', immune: 'Spirit', notes: 'Small creatures that latch onto the player.' },
            { name: 'Dvergr Rogue', biome: 'Mistlands', weak: '', resist: '', immune: 'Spirit', notes: 'Hostile if provoked.' },
            { name: 'Dvergr Mage', biome: 'Mistlands', weak: '', resist: 'Fire, Frost', immune: 'Spirit', notes: 'Hostile if provoked.' },
            { name: 'The Queen', biome: 'Mistlands', weak: '', resist: 'Pierce', immune: 'Spirit', notes: 'Final boss of the Mistlands.' }
        ];

        const arrowData = {
            "Wood Arrow": { Pierce: 22 },
            "Flinthead Arrow": { Pierce: 27 },
            "Bronzehead Arrow": { Pierce: 32 },
            "Ironhead Arrow": { Pierce: 42 },
            "Obsidian Arrow": { Pierce: 52 },
            "Needle Arrow": { Pierce: 62 },
            "Carapace Arrow": { Pierce: 72 },
            "Fire Arrow": { Pierce: 11, Fire: 22 },
            "Frost Arrow": { Pierce: 26, Frost: 52 },
            "Poison Arrow": { Pierce: 26, Poison: 52 },
            "Silver Arrow": { Pierce: 52, Spirit: 20 },
        };

        document.addEventListener('DOMContentLoaded', () => {
            const weaponTableBody = document.getElementById('weapon-table-body');
            const tierFilter = document.getElementById('tier-filter');
            const typeFilter = document.getElementById('type-filter');
            const includePreviousTiersCheckbox = document.getElementById('include-previous-tiers');
            const damageTypeFilterDropdown = document.getElementById('damage-filter-dropdown');
            const damageFilterBtn = document.getElementById('damage-filter-btn');
            const enemySelector = document.getElementById('enemy-selector');
            const skillInputsContainer = document.getElementById('skill-inputs');
            const accordionContainer = document.getElementById('accordion-container');
            const enemyGrid = document.getElementById('enemy-grid');
            const enemyTableContainer = document.getElementById('enemy-table-container');
            const enemyTableBody = document.getElementById('enemy-table-body');
            const enemyBiomeFilter = document.getElementById('enemy-biome-filter');
            const showDamageDetailsCheckbox = document.getElementById('show-damage-details');
            const tablePanel = document.getElementById('table-panel');
            const weaponTableHeader = document.getElementById('weapon-table-header');
            const enemyTableHeader = document.getElementById('enemy-table-header');
            const viewToggleButtons = document.getElementById('view-toggle-buttons');
            const damageBarHeader = document.getElementById('damage-bar-header');
            const skillToggleButton = document.getElementById('skill-toggle-btn');
            const enemyInfoContainer = document.getElementById('enemy-info-container');
            const enemyInfoPanel = document.getElementById('enemy-info-panel');
            const skillInputsWrapper = document.getElementById('skill-inputs-wrapper');
            const arrowFilterContainer = document.getElementById('arrow-filter-container');
            const arrowFilter = document.getElementById('arrow-filter');

            let activeDamageFilters = [];
            let selectedWeapon = null;
            let selectedEnemy = null;
            const tierOrder = ['Meadows', 'Black Forest', 'Swamp', 'Mountains', 'Plains', 'Mistlands'];
            let currentWeaponSort = { key: 'name', direction: 'asc' };
            let currentEnemySort = { key: 'name', direction: 'asc' };
            let currentEnemyView = 'table';
            let weaponUpgradeLevels = {};
            let damageBarMode = 'dps';
            let skillMode = 'mySkills'; // 'mySkills' or 'baseline'
            let userStoredSkills = {};
            
            const skillLevels = { Axes: 0, Bows: 0, Clubs: 0, Knives: 0, Polearms: 0, Spears: 0, Swords: 0, Fists: 0, Crossbows: 0 };
            const weaponTypeToSkillMap = {
                'Axe (1H)': 'Axes', 'Axe (2H)': 'Axes', 'Bow (2H)': 'Bows', 'Club (1H)': 'Clubs', 'Sledge (2H)': 'Clubs',
                'Knife (1H)': 'Knives', 'Atgeir (2H)': 'Polearms', 'Spear (2H)': 'Spears', 'Harpoon (2H)': 'Spears',
                'Sword (1H)': 'Swords', 'Sword (2H)': 'Swords', 'Fist (1H)': 'Fists', 'Crossbow (2H)': 'Crossbows'
            };

            function saveState() {
                const state = {
                    skills: skillLevels,
                    tier: tierFilter.value,
                    type: typeFilter.value,
                    includePrevious: includePreviousTiersCheckbox.checked,
                    damageFilters: activeDamageFilters,
                    enemy: enemySelector.value,
                    showDamage: showDamageDetailsCheckbox.checked,
                    enemyView: currentEnemyView,
                    weaponLevels: weaponUpgradeLevels,
                    damageBarMode: damageBarMode,
                    arrow: arrowFilter.value
                };
                localStorage.setItem('valheimArmoryState', JSON.stringify(state));
            }

            function loadAndApplyState() {
                const savedState = localStorage.getItem('valheimArmoryState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    if (state.skills) Object.assign(skillLevels, state.skills);
                    if (state.weaponLevels) Object.assign(weaponUpgradeLevels, state.weaponLevels);
                    
                    Object.keys(skillLevels).forEach(skill => {
                        const input = document.getElementById(`skill-${skill}`);
                        if (input) input.value = skillLevels[skill];
                    });

                    tierFilter.value = state.tier || 'all';
                    typeFilter.value = state.type || 'all';
                    includePreviousTiersCheckbox.checked = state.includePrevious || false;
                    showDamageDetailsCheckbox.checked = state.showDamage || false;
                    activeDamageFilters = state.damageFilters || [];
                    enemySelector.value = state.enemy || 'none';
                    currentEnemyView = state.enemyView || 'table';
                    damageBarMode = state.damageBarMode || 'dps';
                    arrowFilter.value = state.arrow || 'Wood Arrow';

                    if (enemySelector.value !== 'none') {
                        selectedEnemy = enemyData.find(e => e.name === enemySelector.value);
                    }
                    
                    damageTypeFilterDropdown.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        if (activeDamageFilters.includes(checkbox.value)) {
                            checkbox.checked = true;
                        }
                    });
                    updateDamageFilterButtonText();

                     damageBarHeader.textContent = damageBarMode === 'dps' ? 'DPS' : 'Damage/Hit';
                }
            }

            function populateSkillInputs() {
                skillInputsContainer.innerHTML = '';
                Object.keys(skillLevels).forEach(skill => {
                    const div = document.createElement('div');
                    div.className = "flex-shrink-0";
                    div.innerHTML = `
                        <label for="skill-${skill}" class="block text-sm font-medium text-gray-300">${skill}</label>
                        <input type="number" id="skill-${skill}" data-skill="${skill}" value="0" min="0" max="100" class="skill-input mt-1 block w-16 bg-gray-700 border border-gray-600 rounded-md shadow-sm py-1 px-2 text-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500">
                    `;
                    skillInputsContainer.appendChild(div);
                });

                document.querySelectorAll('.skill-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        if (skillMode === 'mySkills') {
                            const skill = e.target.dataset.skill;
                            let value = parseInt(e.target.value, 10);
                            if (isNaN(value) || value < 0) value = 0;
                            if (value > 100) value = 100;
                            e.target.value = value;
                            skillLevels[skill] = value;
                            updateAllCalculatedColumns();
                            updateEnemyInfoPanel(selectedEnemy, selectedWeapon);
                            saveState();
                        }
                    });
                });
            }

            function populateFilters() {
                tierFilter.innerHTML = '<option value="all">All Tiers</option>';
                tierOrder.forEach(tier => {
                    const option = document.createElement('option');
                    option.value = tier;
                    option.textContent = tier;
                    tierFilter.appendChild(option);
                });

                const types = [...new Set(weaponData.map(w => w.type))].sort();
                typeFilter.innerHTML = '<option value="all">All Types</option>';
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeFilter.appendChild(option);
                });
                
                const allDamageTypes = [...new Set(weaponData.flatMap(w => Object.keys(w.damage)))].sort();
                damageTypeFilterDropdown.innerHTML = '';
                allDamageTypes.forEach(type => {
                    const item = document.createElement('label');
                    item.className = 'flex items-center space-x-2 cursor-pointer';
                    item.innerHTML = `
                        <input type="checkbox" value="${type}" class="damage-type-checkbox h-4 w-4 rounded border-gray-500 bg-gray-800 text-amber-500 focus:ring-amber-500">
                        <span>${type}</span>
                    `;
                    damageTypeFilterDropdown.appendChild(item);
                });

                arrowFilter.innerHTML = '';
                Object.keys(arrowData).forEach(arrowName => {
                    const option = document.createElement('option');
                    option.value = arrowName;
                    option.textContent = arrowName;
                    arrowFilter.appendChild(option);
                });


                const enemyBiomes = [...new Set(enemyData.map(e => e.biome))];
                enemyBiomeFilter.innerHTML = '<option value="all">All Biomes</option>';
                enemyBiomes.forEach(biome => {
                    const option = document.createElement('option');
                    option.value = biome;
                    option.textContent = biome;
                    enemyBiomeFilter.appendChild(option);
                });

                enemyData.sort((a,b) => a.name.localeCompare(b.name)).forEach(enemy => {
                    const option = document.createElement('option');
                    option.value = enemy.name;
                    option.textContent = enemy.name;
                    enemySelector.appendChild(option);
                });
            }
            
            function updateDamageFilterButtonText() {
                if (activeDamageFilters.length === 0) {
                    damageFilterBtn.textContent = 'Select Damage Types';
                } else if (activeDamageFilters.length > 2) {
                    damageFilterBtn.textContent = `${activeDamageFilters.length} types selected`;
                } else {
                    damageFilterBtn.textContent = activeDamageFilters.join(', ');
                }
            }

            function populateCombatAccordion() {
                accordionContainer.innerHTML = '';
                combatData.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-800 rounded-lg shadow-md';
                    div.innerHTML = `
                        <button class="accordion-toggle w-full text-left p-4 font-semibold text-lg text-amber-400 hover:bg-gray-700 rounded-lg flex justify-between items-center">
                            <span>${item.title}</span>
                            <span class="transform transition-transform duration-300">&#9662;</span>
                        </button>
                        <div class="accordion-content px-4 pb-4 text-gray-300">
                            <p>${item.content}</p>
                        </div>
                    `;
                    accordionContainer.appendChild(div);
                });

                document.querySelectorAll('.accordion-toggle').forEach(button => {
                    button.addEventListener('click', () => {
                        const content = button.nextElementSibling;
                        const icon = button.querySelector('span:last-child');
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                            icon.style.transform = 'rotate(0deg)';
                        } else {
                            document.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = null);
                            document.querySelectorAll('.accordion-toggle span:last-child').forEach(i => i.style.transform = 'rotate(0deg)');
                            content.style.maxHeight = content.scrollHeight + "px";
                            icon.style.transform = 'rotate(180deg)';
                        }
                    });
                });
            }

            function populateWeaponTable() {
                const selectedTierValue = tierFilter.value;
                const type = typeFilter.value;
                const includePrevious = includePreviousTiersCheckbox.checked;

                let filteredWeapons = weaponData.filter(weapon => {
                    let tierMatch = false;
                    if (selectedTierValue === 'all') {
                        tierMatch = true;
                    } else if (includePrevious) {
                        const selectedTierIndex = tierOrder.indexOf(selectedTierValue);
                        const allowedTiers = tierOrder.slice(0, selectedTierIndex + 1);
                        tierMatch = allowedTiers.includes(weapon.tier);
                    } else {
                        tierMatch = weapon.tier === selectedTierValue;
                    }

                    const typeMatch = type === 'all' || weapon.type === type;
                    const selectedDamageTypes = activeDamageFilters;
                    const damageMatch = selectedDamageTypes.length === 0 || selectedDamageTypes.some(dtype => Object.keys(weapon.damage).includes(dtype));
                    return tierMatch && typeMatch && damageMatch;
                });

                // Sorting logic
                const sortKey = currentWeaponSort.key;
                const sortDir = currentWeaponSort.direction;
                const isNumeric = ['lvl1', 'lvl2', 'lvl3', 'lvl4', 'vsFoe', 'dps', 'comboDps', 'surpriseAtk', 'secondaryAtk', 'attackSpeed', 'staminaCost', 'dmgPerStamina', 'Blunt', 'Slash', 'Pierce', 'Fire', 'Frost', 'Spirit', 'Poison'].includes(sortKey);

                filteredWeapons.forEach(w => {
                    const increment = (w.maxLvlDamage - w.totalDamage) / 3;
                    w.lvl1 = w.totalDamage;
                    w.lvl2 = Math.round(w.totalDamage + increment);
                    w.lvl3 = Math.round(w.totalDamage + 2 * increment);
                    w.lvl4 = w.maxLvlDamage;
                });

                filteredWeapons.sort((a, b) => {
                    let valA, valB;
                    const damageA = calculateDamage(a, selectedEnemy) || 0;
                    const damageB = calculateDamage(b, selectedEnemy) || 0;

                    if (sortKey === 'vsFoe') {
                        valA = damageA;
                        valB = damageB;
                    } else if (sortKey === 'dps') {
                        valA = damageA / a.attackSpeed;
                        valB = damageB / b.attackSpeed;
                    } else if (sortKey === 'comboDps') {
                        const dpsA = damageA / a.attackSpeed;
                        const dpsB = damageB / b.attackSpeed;
                        valA = a.hasCombo ? (damageA * 4 / 3) / a.attackSpeed : dpsA;
                        valB = b.hasCombo ? (damageB * 4 / 3) / b.attackSpeed : dpsB;
                    } else if (sortKey === 'surpriseAtk') {
                        valA = damageA * a.backstab;
                        valB = damageB * b.backstab;
                    } else if (sortKey === 'secondaryAtk') {
                        valA = damageA * a.secondaryMult;
                        valB = damageB * b.secondaryMult;
                    } else if (sortKey === 'dmgPerStamina') {
                        const skillNameA = weaponTypeToSkillMap[a.type];
                        const skillLevelA = skillNameA ? skillLevels[skillNameA] : 0;
                        const stamA = a.staminaCost * (1 - (skillLevelA / 100) * 0.33);

                        const skillNameB = weaponTypeToSkillMap[b.type];
                        const skillLevelB = skillNameB ? skillLevels[skillNameB] : 0;
                        const stamB = b.staminaCost * (1 - (skillLevelB / 100) * 0.33);

                        valA = (damageA) / (stamA > 0 ? stamA : 1);
                        valB = (damageB) / (stamB > 0 ? stamB : 1);
                    } else if (isNumeric) {
                        valA = a[sortKey] || a.damage[sortKey] || 0;
                        valB = b[sortKey] || b.damage[sortKey] || 0;
                    } else { // String sort
                        valA = a[sortKey].toLowerCase();
                        valB = b[sortKey].toLowerCase();
                    }
                    
                    if (valA < valB) return sortDir === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                });

                weaponTableBody.innerHTML = '';
                filteredWeapons.forEach(weapon => {
                    const row = document.createElement('tr');
                    const weaponId = weapon.name.replace(/\s+/g, '-');
                    row.className = 'border-b border-gray-700 table-row-clickable cursor-pointer';
                    row.dataset.weaponName = weapon.name;
                    row.innerHTML = `
                        <td class="p-2 font-semibold whitespace-nowrap">${weapon.name}</td>
                        <td class="p-2 text-gray-400">${weapon.type}</td>
                        <td class="p-2 text-gray-400">${weapon.tier}</td>
                        <td class="p-2 text-center text-white level-selector" data-level="1">${weapon.lvl1}</td>
                        <td class="p-2 text-center text-gray-400 level-selector" data-level="2">${weapon.lvl2}</td>
                        <td class="p-2 text-center text-gray-400 level-selector" data-level="3">${weapon.lvl3}</td>
                        <td class="p-2 text-center text-gray-400 level-selector" data-level="4">${weapon.lvl4}</td>
                        <td class="p-2 text-center font-bold text-amber-400" id="damage-calc-${weaponId}">-</td>
                        <td class="p-2 text-center font-bold text-amber-400" id="dps-calc-${weaponId}">-</td>
                        <td class="p-2 text-center font-bold" id="combo-dps-calc-${weaponId}">-</td>
                        <td class="p-2 text-center text-gray-400" id="stamina-calc-${weaponId}">-</td>
                        <td class="p-2 text-center font-bold text-amber-400" id="dmg-per-stamina-calc-${weaponId}">-</td>
                        <td class="p-2"><div class="damage-bar-container"><div class="damage-bar" id="damage-bar-${weaponId}"></div></div></td>
                        <td class="p-2 text-center text-gray-400 damage-col">${weapon.damage.Blunt || '-'}</td>
                        <td class="p-2 text-center text-gray-400 damage-col">${weapon.damage.Slash || '-'}</td>
                        <td class="p-2 text-center text-gray-400 damage-col">${weapon.damage.Pierce || '-'}</td>
                    `;
                    row.addEventListener('click', (e) => {
                        if (e.target.classList.contains('level-selector')) {
                            const level = e.target.dataset.level;
                            weaponUpgradeLevels[weapon.name] = parseInt(level, 10);
                            row.querySelectorAll('.level-selector').forEach(cell => cell.classList.remove('level-selected'));
                            e.target.classList.add('level-selected');
                            updateAllCalculatedColumns();
                            updateEnemyInfoPanel(selectedEnemy, selectedWeapon);
                            if (selectedWeapon && selectedWeapon.name === weapon.name) {
                                updateCalculatedDamage(weapon, selectedEnemy);
                            }
                            saveState();
                            return;
                        }

                        document.querySelectorAll('.table-row-clickable').forEach(r => r.classList.remove('selected'));
                        row.classList.add('selected');
                        selectedWeapon = weapon;
                        arrowFilterContainer.classList.toggle('hidden', selectedWeapon.type !== 'Bow (2H)');
                        updateCalculatedDamage(weapon, selectedEnemy);
                        updateEnemyInfoPanel(selectedEnemy, weapon);
                    });

                    const selectedLvl = weaponUpgradeLevels[weapon.name] || 1;
                    row.querySelector(`[data-level="${selectedLvl}"]`).classList.add('level-selected');
                    
                    weaponTableBody.appendChild(row);
                });
                updateAllCalculatedColumns();
                toggleDamageColumns();
            }
            
            function populateEnemyViews() {
                const biome = enemyBiomeFilter.value;
                let filteredEnemies = enemyData.filter(enemy => biome === 'all' || enemy.biome === biome);
                
                // Enemy Table Sorting
                const sortKey = currentEnemySort.key;
                const sortDir = currentEnemySort.direction;
                filteredEnemies.sort((a,b) => {
                    const valA = (a[sortKey] || '').toLowerCase();
                    const valB = (b[sortKey] || '').toLowerCase();
                    if (valA < valB) return sortDir === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                });

                enemyGrid.innerHTML = '';
                enemyTableBody.innerHTML = '';

                filteredEnemies.forEach(enemy => {
                    const weakParts = [];
                    if (enemy.weak) weakParts.push(enemy.weak);
                    if (enemy.veryWeak) weakParts.push(`${enemy.veryWeak}*`);
                    const weakString = weakParts.join(', ');

                    const resistParts = [];
                    if (enemy.resist) resistParts.push(enemy.resist);
                    if (enemy.veryResist) resistParts.push(`${enemy.veryResist}*`);
                    const resistString = resistParts.join(', ');

                    // Card View
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col';
                    card.innerHTML = `
                        <div class="h-24 bg-gray-700 rounded-md mb-4 flex items-center justify-center">
                             <span class="text-gray-500 text-sm">Enemy Art</span>
                        </div>
                        <h4 class="text-lg font-bold text-amber-400">${enemy.name}</h4>
                        <p class="text-sm text-gray-400 mb-3">${enemy.biome}</p>
                        <div class="text-sm space-y-1 mt-auto">
                            <p><strong class="text-green-400">Weak To:</strong> ${weakString || 'None'}</p>
                            <p><strong class="text-red-400">Resists:</strong> ${resistString || 'None'}</p>
                            <p><strong class="text-gray-500">Immune To:</strong> ${enemy.immune || 'None'}</p>
                            <p class="mt-2 pt-2 border-t border-gray-700 text-gray-400">${enemy.notes}</p>
                        </div>
                    `;
                    enemyGrid.appendChild(card);

                    // Table View
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700';
                    row.innerHTML = `
                        <td class="p-2 font-semibold">${enemy.name}</td>
                        <td class="p-2 text-gray-400">${enemy.biome}</td>
                        <td class="p-2 text-gray-400">${weakString || 'None'}</td>
                        <td class="p-2 text-gray-400">${resistString || 'None'}</td>
                        <td class="p-2 text-gray-400">${enemy.immune || 'None'}</td>
                    `;
                    enemyTableBody.appendChild(row);
                });
            }
            
            function updateAllCalculatedColumns() {
                const rows = weaponTableBody.querySelectorAll('tr');
                let maxBarValue = 0;

                // First pass: find the maximum value for scaling
                rows.forEach(row => {
                    const weaponName = row.dataset.weaponName;
                    const weapon = weaponData.find(w => w.name === weaponName);
                    if (weapon) {
                        const damage = calculateDamage(weapon, selectedEnemy);
                        const dps = damage / weapon.attackSpeed;
                        const val = damageBarMode === 'dps' ? dps : damage;
                        if (val > maxBarValue) maxBarValue = val;
                    }
                });

                // Second pass: update all cells and bars
                rows.forEach(row => {
                    const weaponName = row.dataset.weaponName;
                    const weapon = weaponData.find(w => w.name === weaponName);
                    if (weapon) {
                        const damage = calculateDamage(weapon, selectedEnemy);
                        const dps = damage / weapon.attackSpeed;
                        const comboDps = weapon.hasCombo ? (damage * 4 / 3) / weapon.attackSpeed : dps;
                        const surpriseAtk = damage * weapon.backstab;
                        const secondaryAtk = damage * weapon.secondaryMult;
                        const skillName = weaponTypeToSkillMap[weapon.type];
                        const skillLevel = skillName ? skillLevels[skillName] : 0;
                        const stamina = weapon.staminaCost * (1 - (skillLevel / 100) * 0.33);
                        const dmgPerStamina = stamina > 0 ? damage / stamina : Infinity;

                        const damageCell = row.querySelector(`#damage-calc-${weapon.name.replace(/\s+/g, '-')}`);
                        const dpsCell = row.querySelector(`#dps-calc-${weapon.name.replace(/\s+/g, '-')}`);
                        const comboDpsCell = row.querySelector(`#combo-dps-calc-${weapon.name.replace(/\s+/g, '-')}`);
                        const surpriseAtkCell = row.querySelector(`#surprise-atk-calc-${weapon.name.replace(/\s+/g, '-')}`);
                        const secondaryAtkCell = row.querySelector(`#secondary-atk-calc-${weapon.name.replace(/\s+/g, '-')}`);
                        const staminaCell = row.querySelector(`#stamina-calc-${weapon.name.replace(/\s+/g, '-')}`);
                        const dmgPerStaminaCell = row.querySelector(`#dmg-per-stamina-calc-${weapon.name.replace(/\s+/g, '-')}`);
                        const damageBar = row.querySelector(`#damage-bar-${weapon.name.replace(/\s+/g, '-')}`);
                        
                        if (comboDpsCell) comboDpsCell.className = `p-2 text-center font-bold ${weapon.hasCombo ? 'text-amber-400' : 'text-gray-500'}`;

                        if (selectedEnemy) {
                            if(damageCell) damageCell.textContent = damage.toFixed(1);
                            if(dpsCell) dpsCell.textContent = dps.toFixed(1);
                            if(comboDpsCell) comboDpsCell.textContent = comboDps.toFixed(1);
                            if(surpriseAtkCell) surpriseAtkCell.textContent = surpriseAtk.toFixed(1);
                            if(secondaryAtkCell) secondaryAtkCell.textContent = secondaryAtk.toFixed(1);
                            if(staminaCell) staminaCell.textContent = stamina.toFixed(1);
                            if(dmgPerStaminaCell) dmgPerStaminaCell.textContent = isFinite(dmgPerStamina) ? dmgPerStamina.toFixed(2) : 'âˆž';
                            
                            const barValue = damageBarMode === 'dps' ? dps : damage;
                            const barWidth = maxBarValue > 0 ? (barValue / maxBarValue) * 100 : 0;
                            if (damageBar) {
                                damageBar.style.width = `${barWidth}%`;
                                damageBar.textContent = barValue.toFixed(1);
                            }
                        } else {
                            if(damageCell) damageCell.textContent = '-';
                            if(dpsCell) dpsCell.textContent = '-';
                            if(comboDpsCell) comboDpsCell.textContent = '-';
                            if(surpriseAtkCell) surpriseAtkCell.textContent = '-';
                            if(secondaryAtkCell) secondaryAtkCell.textContent = '-';
                            if(staminaCell) staminaCell.textContent = stamina.toFixed(1);
                            if(dmgPerStaminaCell) dmgPerStaminaCell.textContent = '-';
                            if (damageBar) {
                                damageBar.style.width = '0%';
                                damageBar.textContent = '';
                            }
                        }
                    }
                });
            }

            function calculateDamage(weapon, enemy, getBreakdown = false) {
                if (!weapon) return getBreakdown ? { total: 0, breakdown: [] } : 0;
                
                const selectedLevel = weaponUpgradeLevels[weapon.name] || 1;
                const levelDamage = weapon[`lvl${selectedLevel}`];
                const damageRatio = weapon.totalDamage > 0 ? levelDamage / weapon.totalDamage : 1;

                const skillName = weaponTypeToSkillMap[weapon.type];
                const skillLevel = skillName ? skillLevels[skillName] : 0;
                
                let skillFactor;
                if (weapon.type === 'Fist (1H)') {
                    skillFactor = 1 + (skillLevel / 100 * 0.5);
                } else {
                    skillFactor = 1 + (skillLevel / 100 * 0.25);
                }

                let totalModifiedDamage = 0;
                let breakdown = [];
                let combinedDamage = { ...weapon.damage };

                if (weapon.type === 'Bow (2H)') {
                    const selectedArrowName = arrowFilter.value;
                    const arrow = arrowData[selectedArrowName];
                    for (const type in arrow) {
                        combinedDamage[type] = (combinedDamage[type] || 0) + arrow[type];
                    }
                }
                
                for (const [damageType, baseValue] of Object.entries(combinedDamage)) {
                    const levelAdjustedBase = baseValue * damageRatio;
                    const skillBasedDamage = levelAdjustedBase * skillFactor;
                    
                    let modifier = 1;
                    let modifierText = 'Neutral';
                    if (enemy && enemy.immune && enemy.immune.includes(damageType)) {
                        modifier = 0;
                        modifierText = 'Immune (x0)';
                    } else if (enemy && enemy.veryResist && enemy.veryResist.includes(damageType)) {
                        modifier = 0.25;
                        modifierText = '*V.Resist (x0.25)';
                    } else if (enemy && enemy.resist && enemy.resist.includes(damageType)) {
                        modifier = 0.5;
                        modifierText = 'Resist (x0.5)';
                    } else if (enemy && enemy.veryWeak && enemy.veryWeak.includes(damageType)) {
                        modifier = 2.0;
                        modifierText = '*V.Weak (x2.0)';
                    } else if (enemy && enemy.weak && enemy.weak.includes(damageType)) {
                        modifier = 1.5;
                        modifierText = 'Weak (x1.5)';
                    }
                    const finalValue = skillBasedDamage * modifier;
                    totalModifiedDamage += finalValue;
                    if (getBreakdown) {
                        breakdown.push({ type: damageType, base: levelAdjustedBase, skill: skillFactor, mod: modifierText, final: finalValue });
                    }
                }
                return getBreakdown ? { total: totalModifiedDamage, breakdown: breakdown } : totalModifiedDamage;
            }

            function updateEnemyInfoPanel(enemy, weapon) {
                if (!enemy) {
                    enemyInfoContainer.classList.add('hidden');
                    return;
                }
                enemyInfoContainer.classList.remove('hidden');

                const weakParts = [];
                if (enemy.weak) weakParts.push(enemy.weak);
                if (enemy.veryWeak) weakParts.push(`${enemy.veryWeak}*`);
                const weakString = weakParts.join(', ') || 'None';

                const resistParts = [];
                if (enemy.resist) resistParts.push(enemy.resist);
                if (enemy.veryResist) resistParts.push(`${enemy.veryResist}*`);
                const resistString = resistParts.join(', ') || 'None';

                let html = `
                    <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm">
                        <div>
                            <p><strong class="text-green-400">Weak To:</strong> ${weakString}</p>
                            <p><strong class="text-red-400">Resists:</strong> ${resistString}</p>
                            <p><strong class="text-gray-500">Immune To:</strong> ${enemy.immune || 'None'}</p>
                        </div>
                `;

                if (weapon) {
                    const { breakdown } = calculateDamage(weapon, enemy, true);
                    
                    let breakdownHtml = `<div class="text-xs text-gray-400 space-y-1">`;
                    breakdown.forEach(item => {
                        breakdownHtml += `<p>${item.type}: ${item.base.toFixed(1)} <span class="text-gray-500">(base)</span> &times; ${item.skill.toFixed(2)} <span class="text-gray-500">(skill)</span> &times; ${item.mod} = <span class="font-semibold text-white">${item.final.toFixed(1)}</span></p>`;
                    });
                    breakdownHtml += `</div>`;

                    html += `
                        <div>
                            <h4 class="font-bold text-amber-400">${weapon.name} vs. ${enemy.name}</h4>
                            ${breakdownHtml}
                        </div>
                    `;
                }

                html += '</div>';
                enemyInfoPanel.innerHTML = html;
            }

            function updateCalculatedDamage(weapon, enemy) {
                updateEnemyInfoPanel(enemy, weapon);
            }
            
            function toggleDamageColumns() {
                const isHidden = !showDamageDetailsCheckbox.checked;
                document.querySelectorAll('.damage-col').forEach(col => {
                    col.classList.toggle('hidden', isHidden);
                });
            }

            function setEnemyView(view) {
                currentEnemyView = view;
                if (view === 'table') {
                    enemyGrid.classList.add('hidden');
                    enemyTableContainer.classList.remove('hidden');
                } else {
                    enemyGrid.classList.remove('hidden');
                    enemyTableContainer.classList.add('hidden');
                }
                viewToggleButtons.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === view);
                });
                saveState();
            }

            // Event Listeners
            damageFilterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                damageTypeFilterDropdown.classList.toggle('hidden');
            });

            window.addEventListener('click', (e) => {
                if (!damageTypeFilterDropdown.classList.contains('hidden') && !damageFilterBtn.contains(e.target)) {
                    damageTypeFilterDropdown.classList.add('hidden');
                }
            });

            damageTypeFilterDropdown.addEventListener('change', (e) => {
                if (e.target.classList.contains('damage-type-checkbox')) {
                    activeDamageFilters = Array.from(damageTypeFilterDropdown.querySelectorAll('input:checked')).map(cb => cb.value);
                    updateDamageFilterButtonText();
                    populateWeaponTable();
                    saveState();
                }
            });

            damageBarHeader.addEventListener('click', () => {
                damageBarMode = damageBarMode === 'dps' ? 'vsFoe' : 'dps';
                damageBarHeader.textContent = damageBarMode === 'dps' ? 'DPS' : 'Damage/Hit';
                currentWeaponSort.key = damageBarMode;
                currentWeaponSort.direction = 'desc';
                weaponTableHeader.querySelectorAll('th').forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                });
                damageBarHeader.classList.add('sort-desc');
                populateWeaponTable();
                saveState();
            });

            enemySelector.addEventListener('change', () => {
                const enemyName = enemySelector.value;
                if (enemyName === 'none') {
                    selectedEnemy = null;
                } else {
                    selectedEnemy = enemyData.find(e => e.name === enemyName);
                }
                updateAllCalculatedColumns();
                updateCalculatedDamage(selectedWeapon, selectedEnemy);
                saveState();
            });

            weaponTableHeader.addEventListener('click', (e) => {
                const th = e.target.closest('th');
                if (!th || !th.classList.contains('sortable') || th.id === 'damage-bar-header') return;
                
                const sortKey = th.dataset.sort;
                if (currentWeaponSort.key === sortKey) {
                    currentWeaponSort.direction = currentWeaponSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentWeaponSort.key = sortKey;
                    currentWeaponSort.direction = 'desc'; // Default to descending for numeric
                    if(['name', 'type', 'tier'].includes(sortKey)) currentWeaponSort.direction = 'asc'; // Default to ascending for text
                }

                weaponTableHeader.querySelectorAll('th').forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                });
                th.classList.add(currentWeaponSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');

                populateWeaponTable();
            });

            enemyTableHeader.addEventListener('click', (e) => {
                const th = e.target.closest('th');
                if (!th || !th.classList.contains('sortable')) return;
                
                const sortKey = th.dataset.sort;
                if (currentEnemySort.key === sortKey) {
                    currentEnemySort.direction = currentEnemySort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentEnemySort.key = sortKey;
                    currentEnemySort.direction = 'asc';
                }

                enemyTableHeader.querySelectorAll('th').forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                });
                th.classList.add(currentEnemySort.direction === 'asc' ? 'sort-asc' : 'sort-desc');

                populateEnemyViews();
            });

            skillToggleButton.addEventListener('click', () => {
                if (skillMode === 'mySkills') {
                    // Switch to baseline
                    skillMode = 'baseline';
                    skillToggleButton.textContent = 'Baseline Skills';
                    skillToggleButton.classList.remove('active');
                    userStoredSkills = { ...skillLevels };
                    
                    Object.keys(skillLevels).forEach(skill => {
                        skillLevels[skill] = 0;
                    });
                    
                    document.querySelectorAll('.skill-input').forEach(input => {
                        input.value = 0;
                        input.disabled = true;
                        input.classList.add('bg-gray-800');
                    });
                } else {
                    // Switch back to mySkills
                    skillMode = 'mySkills';
                    skillToggleButton.textContent = 'My Skills';
                    skillToggleButton.classList.add('active');
                    Object.assign(skillLevels, userStoredSkills);
                    
                    document.querySelectorAll('.skill-input').forEach(input => {
                        const skill = input.dataset.skill;
                        input.value = skillLevels[skill];
                        input.disabled = false;
                        input.classList.remove('bg-gray-800');
                    });
                }
                updateAllCalculatedColumns();
                updateCalculatedDamage(selectedWeapon, selectedEnemy);
            });

            tierFilter.addEventListener('change', () => { populateWeaponTable(); saveState(); });
            typeFilter.addEventListener('change', () => {
                arrowFilterContainer.classList.toggle('hidden', typeFilter.value !== 'Bow (2H)');
                populateWeaponTable(); 
                saveState(); 
            });
            arrowFilter.addEventListener('change', () => {
                updateAllCalculatedColumns();
                updateCalculatedDamage(selectedWeapon, selectedEnemy);
                saveState();
            });
            includePreviousTiersCheckbox.addEventListener('change', () => { populateWeaponTable(); saveState(); });
            enemyBiomeFilter.addEventListener('change', populateEnemyViews);
            showDamageDetailsCheckbox.addEventListener('change', () => { toggleDamageColumns(); saveState(); });
            viewToggleButtons.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    setEnemyView(e.target.dataset.view);
                }
            });

            // --- INITIALIZATION ---
            populateFilters();
            populateSkillInputs();
            loadAndApplyState();
            
            // FOR TESTING: Apply user-requested settings for this session
            tierFilter.value = 'Meadows';
            enemySelector.value = 'Greydwarf Brute';
            selectedEnemy = enemyData.find(e => e.name === 'Greydwarf Brute');
            currentWeaponSort = { key: 'vsFoe', direction: 'desc' };
            saveState();

            populateWeaponTable();
            populateCombatAccordion();
            populateEnemyViews();
            setEnemyView(currentEnemyView);
            toggleDamageColumns();
            updateEnemyInfoPanel(selectedEnemy, selectedWeapon);
            
            if (weaponTableBody.querySelector('tr')) {
                weaponTableBody.querySelector('tr').click();
            } else {
                 updateCalculatedDamage(selectedWeapon, selectedEnemy);
            }

            const sections = document.querySelectorAll('main section');
            const navLinks = document.querySelectorAll('.nav-link');
            const mobileNav = document.getElementById('mobile-nav');

            function showSection(hash) {
                sections.forEach(section => {
                    if ('#' + section.id === hash) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });
                navLinks.forEach(link => {
                    if (link.getAttribute('href') === hash) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
                if (document.getElementById(hash.substring(1))) {
                     mobileNav.value = hash;
                }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const hash = e.target.getAttribute('href');
                    history.pushState(null, null, hash);
                    showSection(hash);
                });
            });
            
            mobileNav.addEventListener('change', (e) => {
                 const hash = e.target.value;
                 history.pushState(null, null, hash);
                 showSection(hash);
            });

            window.addEventListener('popstate', () => {
                showSection(window.location.hash || '#explorer');
            });

            showSection(window.location.hash || '#explorer');
        });
    </script>
</body>
</html>
